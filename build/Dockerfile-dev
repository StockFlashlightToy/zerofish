# this dockerfile does not use patch files. it uses your local sources.
# these 2 repos are expected in the zerofish/build directory:
# git clone -b v0.29.0 --depth 1 https://github.com/LeelaChessZero/lc0
# git clone -b sf_16 --depth 1 https://github.com/offical-stockfish/Stockfish
# then you may apply lc0.patch & stockfish.patch or go your own route

FROM emscripten/emsdk
RUN apt-get update && apt-get install -y ninja-build
RUN pip3 install meson

COPY src/emscripten/* /

WORKDIR /lc0
COPY build/lc0 .
COPY build/emccCross.txt .
RUN mkdir -p build/release
COPY build/weights.pb build/release
RUN bash -c "./build.sh -Dgtest=false --cross-file=emccCross.txt --default-library=static"
RUN cat /createRequire.js build/release/lc0.worker.js > /lc0.worker.js
RUN sed -i '0,/require/{s/require/globalThis.require/}' build/release/lc0.js
RUN cat /createRequire.js build/release/lc0.js > /lc0.js
RUN mv build/release/lc0.wasm /lc0.wasm

WORKDIR /Stockfish
COPY build/Stockfish .
WORKDIR /Stockfish/src
COPY build/stockfish.Makefile Makefile
RUN make
RUN cat /createRequire.js stockfish.worker.js > /stockfish.worker.js
#RUN sed -i '0,/require/{s/require/globalThis.require/}' stockfish.js
RUN cat /createRequire.js stockfish.js > /stockfish.js
RUN mv stockfish.wasm /stockfish.wasm
